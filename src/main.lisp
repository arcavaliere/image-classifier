(defpackage image-classifier
  (:use :cl)
  (:import-from :alexandria
                :hash-table-plist)
  (:import-from :yason
                :parse
                :with-output-to-string*
                :encode-plist)
  (:import-from :snooze :defroute :http-condition :payload-as-string)
  (:import-from :lparallel :make-channel :*kernel* :make-kernel :submit-task :receive-result)
  (:import-from :qbase64 :decode-string)
  (:export :start :stop :Image))
(in-package :image-classifier)

(cl-interpol:enable-interpol-syntax)

(defparameter *api-url* "http://gelbooru.me/index.php?")
(defparameter *api-creds* (uiop:getenv "IC_API_CREDS"))
(defparameter *request-timeout* 300)
(defparameter *picture-directory* (uiop:getenv "IC_PICTURE_ROOT"))

(setf lparallel:*kernel* (lparallel:make-kernel 2))


;;; Data Acquisition Functions

;; Grab Posts
(defun get-posts (tags)
  (let ((formatted-tags (format nil "狺磲疸狎灬礅溽螬？え螬Β翎珞┅┅眭祠轲戾鲠祯瀛忾钿ㄢ镤篝狒躞桢徜弪螬ㄤ屮虹弭？え狃榄躜飒疳珏戒狃棣蠼痫篝窠轭溴牦镱奖扉黹艚卑唉翎珞饯ㄦ矧磲趑邃翎珞─í狃榄泸邃螵恒镱铄泗糸礤秕蝈聃弩舡糸礤秕舄候遽洵糸礤秕蝈聃弩舡糸礤秕舄ㄡ篌弪舶篝狒躞┅怙澌┅换蔑铞弪视衔嘛澌麸柔箬葬忪弩ㄤ彐躅泔铞弪舡牦镱麸栳箬ㄢ镤狍镱吼狎箦ㄣ徜潋篝蚝箴扉＼五黛轭怙澌┅┅换砒趄徙骈戾啧蜢ㄤ彐躅珏舡骈戾躜祗蝈箴镱箦翎忪弩磲疸狎灬礅溽翎忪濠ㄧ弭栳箬㈡殪暹躜膦翎忪濠蝈箴镱箦翎忪弩┅换砒趄徙轫徵钺礤ㄤ彐躅珏舡轫徵瀛钺礤蝈箴镱箦翎忪濠ㄧ弭栳箬㈤磲珏蝈箴镱箦翎忪濠换砒趄徙轫徵屮翦铙轱ㄤ彐躅珏舡轫徵瀛屮翦铙轱蝈箴镱箦翎忪濠篝蚝躅扉铄ㄣ潋篝蚝箴扉ㄧ弭栳箬㈤磲珏蝈箴镱箦翎忪濠┅┅换球徕轫徵ㄤ彐躅珏舡轫徵ㄦ殪瀛躜飑眭祠轲戾鲠祯瀛忾钿ㄢ镤篝狒躞桢徜弪螬ㄤ屮虹弭骈戾躜烘矧沐忾钺蝙恒镱铄泗糸礤秕蝈聃弩舡糸礤秕舄候遽洵糸礤秕蝈聃弩舡糸礤秕舄ㄡ篌弪舶篝狒躞┅怙澌┅换昨轸麸骈戾ㄤ彐躅黩轸瀛轫徵瀛麸骈戾ㄩ磲珏蝈聃弩轫徵瀛钺礤轫徵瀛屮翦铙轱翎绛溟蝈泗矧鏖翳镳孱篝蝈犴篝蝈犴ㄦ戾榄篝蝈犴蠛磲脲轭礤盹蝙轭瘐舡篝蝈犴轫徵瀛蝈聃弩舂戾è轫徵镳糸沆候遽洵轫徵瀛篝蝈犴篝蝈犴ㄩ铘弪篝蜷铉躔汜箦轫徵瀛屮翦铙轱瞟弘妁黠蜾┅┅镳糸沆瑚蜷翦轫徵瀛骈戾？え翎绛溟蝈泗矧─ㄩ磲珏钺礤镳糸沆候弩辁瀛轫徵轫徵巢巢┅┅ㄤ彐躅泔祆狒瀛轫徵瀛轭骘蝽狒轱翎忪弩翎绛溟蝈泗矧磲疸狎灬礅溽翎忪濠眭祠轲戾鲠祯瀛忾钿ㄩ磲珏溽翎轫徵瀛钺礤轫徵瀛屮翦铙轱瞟鲠祯弩ㄧ弭轫徵ㄧ弭栳箬㈡殪暹躜膦翎忪濠ㄧ弭轫徵瀛钺礤翎忪濠ㄧ弭轫徵瀛屮翦铙轱翎忪濠ㄨ犷潇弪汜箦黩轸瀛轫徵瀛麸骈戾轫徵瀛溽翎轫徵瀛钺礤轫徵瀛屮翦铙轱翎绛溟蝈泗矧ㄊ信呛躅篚痧矧翦洵牮彗骘蝽狒ㄣㄦ矧磲⒙徜牮彗狺アㄧ弭栳箬㈡殪暹躜膦翎忪濠┅ㄗ晌仍孕汉鏖瞽弪蝻ㄥㄦ矧磲狺ア濠ㄥ蝌矧ㄥㄦ矧磲狺ア濠┅轫徵瀛钺礤┅翎忪弩┅ㄤ彐躅泔祆邈舡轫徵弩翎珞戾舄è痫篝ㄧ弭痫篝翎珞┅翎忪弩ㄣ镱鲥螋牦镱麸栳箬痫篝螬翎绛溟蝈泗矧ㄦ矧磲铋狺磲疸狎灬礅溽螬？え螬翎珞┅翎绛溟蝈泗矧疳翳？え痖泗躜瀛溟蝈泗矧─翎绛溟蝈泗矧┅ㄥ铙躜瀛溟蝈泗矧殄蟓屮轶翎绛溟蝈泗矧疳翳ㄣ镬灬翦轫徵瀛轭骘蝽狒轱翎忪弩翎绛溟蝈泗矧疳翳┅换遗釉骢深翦蜴徙箢镲瀛沆徙氕桴钽桢铘镲舂换箢镲ㄤ彐鲠栳钿戾颡铋飑ㄤ彐躅篝狎é脲痫螋蛋鞍┅篝镳箦赳栳钿戾颡ㄣ灬汶恒灬汶躔箢镲搴磲脲沆徙氕狃皓吼矧痫螋┅ㄤ彐躅篝镳ī麒孱栳钿戾颡ㄣ灬汶后麸栳钿戾颡箦赳栳钿戾颡铋飑┅换项蝻豸骘趄殓珏蜷铉溽翎徙聃轶轸轱ㄤ彐蝻豸滹黝祜徜ê痫篝⑨痧扉汜糸镱牦镱戾è牦镱ㄨ犷潇弪汜箦狍镱吼狎箦疳祜徜狍篝蜷铉┅ㄥ蝌矧ㄥㄨ趑瓠泔钿轸轱窗⑼犰骘蝽邃视衔岍、濠┅ㄣ栳铑屐磲脲汨犷铄飑┅篚忭轸翎箅汨犷铄灬礅溽īㄣ镬戾泗轫徵弩ㄧ弭栳箬Ⅳ徵螈牦镱┅┅ㄨ趑瓠泔钿轸轱舶癌蝈沐轹瀛蝈篚祠汨犷铄飑┅ㄤ彐蝻豸沆狍箝纟ê痫篝⑨痧扉汜糸镱牦镱戾è牦镱ㄨ犷潇弪汜箦疳蝮疳祜徜狍篝蜷铉┅ㄥ蝌矧ㄥㄨ趑瓠泔钿轸轱窗⑼犰骘蝽邃视衔岍、濠┅ㄣ栳铑屐磲脲汨犷铄飑┅篚忭轸翎箅汨犷铄灬礅溽ī戾è轫徵磲脲轫徵烘遽趱蝈Ж轰狒镳糸沆候遽洵轫徵瀛篝蝈犴ㄦ戾榄篝蝈犴蠛磲脲轭礤盹蝙轭瘐舡篝蝈犴ㄤ邈镤瀛篝蜷铉ㄧ弭栳箬㈤磲珏牦镱┅ㄩ铘弪篝蜷铉躔汜箦ㄧ弭栳箬Ⅳ疱牦镱┅弘妁黠蜾┅烘殪孱犴ㄧ弭栳箬㈩犴澧牦镱┅┅ㄢ轭驽狒躜弩ㄥ趄徙舡驽狒躜弩铄狎弩舡铄殓桠矧ㄧ弭栳箬㈦牦镱轫徵濠┅┅鏖翳秕麴豸麸篝蜷铉ê篝蝈犴簌礅镬秕舂ㄥ钽镤瀛痨轶ㄡ戾犷潋獒鸿狍璀翎忪瀛痨轶蝈沐轹瀛蝈篚祠汨犷铄飑秕舂┅换身徵渺狍箝骈汜糸镱ㄋ挝换身徵郁蝓泗ㄤ彐篝蝓泗身徵驽狒躜弩溽翎骈戾钺礤溟篝犷沐ㄤ彐躅轫徵瀛麸犰轶ㄩ磲珏疳轵扉扉篝㈡遽趱蝈螈㈡殪孱犴澧溟篝犷沐扉篝ㄩ磲珏驽狒躜弩轫徵濠钺礤篝蜷铉ㄩ磲珏骈戾钺礤轫徵濠ㄩ磲珏溟篝犷沐轫徵濠┅换谁挝ㄤ彐躅艴沆殇遽瞽溟篝犷沐ㄤ狒岘痫轭趔溽翎痫轭趔猢篑螋蝈漉沐＇磲鲥泗矧灬礅溽ㄡ猢ㄥ痿ō猢博溽翎痫轭趔溽翎痫轭趔猢┅ㄤ彐躅珏舡轫徵瀛溟篝犷沐ㄩ磲珏轫徵瀛猢ㄥ蹉扉溴犷溟篝犷沐ㄡ镳蠛骒狒翦镳糸沆恒镥蜚瀛轫徵轫徵瀛э痿殂旌腑忾舡蜱猸轫徵濠ㄡ镳蠛骒狒翦镳糸沆恒镥蜚瀛轫徵轫徵瀛э痿殂旌腑忾舡蜱猸轫徵濠┅ㄤ彐躅汜煦蹯狒瀛轫徵瀛溟篝犷沐趄衢铋铉轫徵弩翦篝轫徵濠磲疸狎灬礅溽ㄩ磲珏戾è溟篝犷沐ㄧ弭轫徵瀛溟篝犷沐ㄩ磲珏溽翎轫徵濠ㄩ磲珏溽翎翦篝轫徵濠┅箦翩ㄩ磲珏溟篝犷沐轫徵濠溟篝犷沐轫徵濠趄衢铋铉轫徵弩┅ㄤ彐躅珏舡趄衢铋铉轫徵弩ī戾è溟蝈泗矧殄蹰镳后踱溟蝈泗矧殄痖泗躜瀛溟蝈泗矧┅磲疸狎灬礅溽ㄤ轵邈麸蝙戾è翎珞篝蚝箴扉舡镯轸铛祆ㄣ徜潋篝蚝箴扉舡镯轸铛祆钺礤篝蜷铉溟蝈泗矧┅┅ㄦ殪孱犴弩蹰镳轰轵邈麸蝙骈戾溟蝈泗矧┅磲疸狎灬礅溽ㄦ殪孱犴濠磲脲轫徵烘遽趱蝈翎珞轰狒镳糸沆候遽洵轫徵瀛骈戾骈戾钺礤烘殪孱犴骈戾钺礤┅骈戾钺礤螬┅溟蝈泗矧殄螬┅ㄤ彐躅汜煦蹯狒瀛溟篝犷沐蟓骝镯趄衢铋铉溽翎躅腩秣瞽轫徵濠磲疸狎灬礅溽ㄩ磲珏螬ㄣ犰沲灬翦轫徵瀛溟篝犷沐轫徵弩躅腩秣瞽轫徵濠ㄧ弭趄衢铋铉轫徵弩┅ㄤ彐躅箫螋怡溟篝犷沐趄衢铄洵轫徵弩箫螋蝈漉沐＇狃疱钿趄衢铄洵轫徵弩灬礅溽ㄡ猢ㄩ磲珏溟篝犷沐岍ㄩ磲珏溟篝犷沐猢┅┅ㄤ彐躅铄狎弩舡铄殓桠矧躅腩秣瞽轫徵濠篚怏羼箫螋怡溟篝犷沐ㄣ犰沲灬翦溟篝犷沐蟓骝镯趄衢铋铉溽翎躅腩秣瞽轫徵濠ō暴┅换棋狒躜砒趄徙糸镱ㄤ彐躅屮趄徙舡驽狒躜弩铄殓桠矧螬蝈漉沐＇狃疱钿磲疸狎＇轫徵瀛驽狒躜弩铄殓桠矧螬┅ㄤ彐躅忾瞽驽狒躜弩ㄦ遽趱蝈螬戾è栳箬磲脲栳箬翎忪濠┅磲疸狎灬礅溽ㄡㄩㄧ弭栳箬栳箬箦翩ㄧ弭栳箬栳箬ǐㄧ弭栳箬栳箬┅箦翩ㄧ弭栳箬栳箬暴┅驽狒躜弩栳箬┅